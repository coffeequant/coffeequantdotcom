<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>IUL Vol-Target Lab — CoffeeQuant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Site theme -->
  <link rel="stylesheet" href="../css/cq.css"/>

  <!-- MathJax (global v3) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['\\[','\\]'], ['$$','$$']],
        processEscapes: true,
        tags: 'ams'
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <style>
    /* Page-specific tweaks that sit on top of cq.css */
    .lab-shell { max-width: 1100px; margin: 0 auto; padding: 1rem 1.25rem 2rem; }
    .lab-header h1 { font-size: 1.9rem; margin:.2rem 0 .6rem; letter-spacing:-.01em; }
    .lab-grid { display:grid; grid-template-columns: 360px 1fr; gap:1rem; align-items:start; }
    .lab-card { background: var(--card); border:1px solid var(--line); border-radius: var(--radius); padding:1rem; }
    .lab-form label { display:block; font-size:.9rem; color:var(--muted); margin-top:.7rem; }
    .lab-form input { width:100%; padding:.55rem .65rem; border:1px solid var(--line); border-radius:10px; background:transparent; color:var(--fg); }
    .lab-actions { display:flex; gap:.5rem; margin-top:.9rem; }
    .lab-metrics { display:grid; grid-template-columns: repeat(3, 1fr); gap:.5rem; margin-top:.8rem; }
    .metric { background:color-mix(in oklab, currentColor 8%, transparent); border:1px solid color-mix(in oklab, currentColor 20%, transparent); border-radius:10px; padding:.65rem .7rem; }
    .metric .k { font-size:.78rem; color:var(--muted); }
    .metric .v { font-weight:700; }
    .sparkline { width:100%; height:260px; border:1px solid var(--line); border-radius:12px; background: transparent; }
    .muted { color: var(--muted); }
    details.lab-notes { border:1px dashed var(--line); border-radius:12px; padding:.7rem .9rem; }
    details summary { cursor:pointer; font-weight:600; }
    .code { font-family: var(--font-mono); font-size:.85rem; padding:.35rem .5rem; border:1px solid var(--line); border-radius:8px; display:inline-block; }
    @media (max-width: 980px) { .lab-grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>

  <div class="lab-shell">
    <header class="lab-header">
      <h1>IUL Vol-Target Lab</h1>
      <p class="muted">
        Price a simple **annual reset** IUL crediting rule on a vol-target (excess-return) index.
        Play with inputs, see price bands, and read the intuition below.
      </p>
    </header>

    <section class="lab-grid">
      <!-- LEFT: Inputs -->
      <div class="lab-card lab-form" aria-label="Inputs">
        <h3 style="margin-top:0">Inputs</h3>

        <label for="s0">Index level $S_0$</label>
        <input id="s0" type="number" step="1" value="100"/>

        <label for="vt">Vol target (annual, e.g. 0.12)</label>
        <input id="vt" type="number" step="0.005" value="0.12"/>

        <label for="alpha">Participation $\\alpha$</label>
        <input id="alpha" type="number" step="0.05" value="1.00"/>

        <label for="cap">Cap (e.g. 0.12 for +12%)</label>
        <input id="cap" type="number" step="0.01" value="0.12"/>

        <label for="floor">Floor (e.g. 0.00 or -0.05)</label>
        <input id="floor" type="number" step="0.01" value="0.00"/>

        <label for="rate">Discount rate $r$ (for PV)</label>
        <input id="rate" type="number" step="0.005" value="0.02"/>

        <label for="sims">Monte Carlo paths</label>
        <input id="sims" type="number" step="1000" value="30000"/>

        <div class="lab-actions">
          <button class="cq-btn" id="btnRun">▶ Run pricing</button>
          <button class="cq-btn-ghost" id="btnClear">Clear</button>
        </div>

        <p id="errBox" class="muted" style="margin-top:.6rem; white-space:pre-wrap;"></p>
      </div>

      <!-- RIGHT: Results -->
      <div class="lab-card" aria-label="Results">
        <h3 style="margin-top:0">Results</h3>

        <div class="lab-metrics">
          <div class="metric">
            <div class="k">Mean credit (1y)</div>
            <div class="v" id="mMean">—</div>
          </div>
          <div class="metric">
            <div class="k">PV of credit</div>
            <div class="v" id="mPV">—</div>
          </div>
          <div class="metric">
            <div class="k">P5–P95 band</div>
            <div class="v" id="mBand">—</div>
          </div>
        </div>

        <canvas id="hist" class="sparkline" aria-label="Distribution of credited return"></canvas>

        <details class="lab-notes" style="margin-top:.8rem">
          <summary>What’s being priced?</summary>
          <div style="margin-top:.5rem">
            <p>
              Annual reset credit on the **excess return** of a vol-target index:
            </p>
            <p>
              \\[
                R_T \;=\; \\frac{S_T}{S_0}-1,\\qquad
                \\text{Credit}\\;=\\; \\min\\!\\big(\\max(\\alpha R_T,\\,\\underline c),\\,\\overline c\\big)
              \\]
              with vol target \\(\\sigma_{VT}\\) and **risk-neutral** excess-return dynamic
              \\(S_T = S_0\\,\\exp(-\\tfrac12\\sigma_{VT}^2T + \\sigma_{VT}\\sqrt{T}\\,Z)\\).
            </p>
            <p class="muted small">
              (No equity drift: that’s why vol-target ER under Q is cheaper and cleaner vs a price-return index.)
            </p>
          </div>
        </details>
      </div>
    </section>

    <!-- EXPLANATION -->
    <section class="lab-card" style="margin-top:1rem">
      <h3 style="margin-top:0">Quick refresher: IUL, vol-target, and “excess return”</h3>
      <ol>
        <li><strong>IUL chassis</strong>: Policy value earns an annual credit subject to **cap/floor/participation**; downside is limited by the floor (often 0%).</li>
        <li><strong>Why vol-target?</strong> A managed index with (say) 10–12% volatility aims to deliver smoother outcomes. In risk-neutral pricing of **excess return**, expected drift is 0. Cleaner hedge = cleaner price.</li>
        <li><strong>Client story</strong> (keep it simple):
          <ul>
            <li>“We cap the upside, cushion the downside.”</li>
            <li>“The index keeps risk steady, so the credit is steadier.”</li>
            <li>“Because we hedge the excess return, the ‘fair’ price is lower than a full price-return option at positive rates.”</li>
          </ul>
        </li>
      </ol>

      <h4>Math compactly</h4>
      <p>
        One-year credit PV:
        \\[
          \\text{PV} \\approx e^{-rT}\\,\\mathbb{E}[\\min(\\max(\\alpha R_T,\\underline c),\\overline c)]\\,,
          \\quad R_T=\\exp(-\\tfrac12\\sigma^2 T + \\sigma\\sqrt{T}Z)-1.
        \\]
        This lab uses Monte Carlo to estimate the expectation and show bands (P5–P95).
      </p>

      <h4>Linking to products</h4>
      <ul>
        <li>Want higher advertised credit? Increase \\(\\alpha\\) or cap \\(\\overline c\\). Price responds immediately.</li>
        <li>Want stronger downside buffer? Raise the floor \\(\\underline c\\) (cost goes up).</li>
        <li>Distribution docs: show the band from the histogram to set realistic expectations.</li>
      </ul>
    </section>

  </div>

  <script>
  // ----------- helpers -----------
  const $ = (sel, root=document)=>root.querySelector(sel);

  async function postJSON(url, body){
    const r = await fetch(url, {
      method: 'POST',
      headers: {'content-type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok){
      const t = await r.text().catch(()=> '');
      throw new Error(`HTTP ${r.status} ${t}`);
    }
    return r.json();
  }

  function pct(x){ return (x*100).toFixed(2) + '%'; }

  // ----------- draw hist -----------
  function drawHist(canvas, samples){
    const ctx = canvas.getContext('2d');
    const W = canvas.width = canvas.clientWidth * window.devicePixelRatio;
    const H = canvas.height = 260 * window.devicePixelRatio;
    ctx.setTransform(window.devicePixelRatio,0,0,window.devicePixelRatio,0,0);
    ctx.clearRect(0,0,W,H);

    if(!samples || !samples.length) return;

    // Build histogram (50 bins from min to max)
    const nBins = 50;
    const mn = Math.min(...samples), mx = Math.max(...samples);
    const pad = (mx - mn) * 0.06 || 0.01;
    const lo = mn - pad, hi = mx + pad;
    const bins = new Array(nBins).fill(0);
    for(const x of samples){
      const t = Math.max(0, Math.min(nBins-1, Math.floor((x - lo)/(hi - lo) * nBins)));
      bins[t]++;
    }
    const maxCnt = Math.max(...bins) || 1;

    // plot rect
    const left=40, right=12, top=12, bottom=28;
    const pw = canvas.clientWidth - left - right;
    const ph = 260 - top - bottom;

    // axes
    ctx.strokeStyle = getComputedStyle(document.body).color;
    ctx.globalAlpha = .3;
    ctx.beginPath();
    ctx.moveTo(left, top); ctx.lineTo(left, top+ph); ctx.lineTo(left+pw, top+ph);
    ctx.stroke();
    ctx.globalAlpha = 1;

    // bars
    const bw = pw / nBins;
    ctx.fillStyle = getComputedStyle(document.body).color;
    ctx.globalAlpha = .18;
    for(let i=0;i<nBins;i++){
      const h = (bins[i]/maxCnt) * ph;
      const x = left + i*bw;
      const y = top + ph - h;
      ctx.fillRect(x,y,bw*0.92,h);
    }
    ctx.globalAlpha = 1;

    // x tick labels: min / median / max
    const med = samples.slice().sort((a,b)=>a-b)[Math.floor(samples.length/2)];
    ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(pct(lo), left, top+ph+18);
    ctx.fillText(pct(med), left+pw/2-16, top+ph+18);
    ctx.fillText(pct(hi), left+pw-44, top+ph+18);
  }

  // ----------- API wiring -----------
  const API = '/api/iul/vt_price';

  async function runPricing(){
    $('#errBox').textContent = '';
    $('#mMean').textContent = '—';
    $('#mPV').textContent = '—';
    $('#mBand').textContent = '—';
    drawHist($('#hist'), []); // clear

    const payload = {
      s0: Number($('#s0').value || 100),
      vt_vol: Number($('#vt').value || 0.12),
      alpha: Number($('#alpha').value || 1.0),
      cap: Number($('#cap').value || 0.12),
      floor: Number($('#floor').value || 0.0),
      tenor_y: 1.0,
      sims: Math.max(1000, Number($('#sims').value || 20000)|0),
      r: Number($('#rate').value || 0.02)
    };

    try {
      const j = await postJSON(API, payload);
      if (typeof j.mean_credit !== 'number') {
        console.warn('Unexpected payload', j);
        throw new Error('Bad API payload: mean_credit missing');
      }
      $('#mMean').textContent = pct(j.mean_credit);
      $('#mPV').textContent   = pct(j.price_pv);
      $('#mBand').textContent = `${pct(j.p5)} – ${pct(j.p95)}`;

      // fabricate samples around P5–P95 for a quick feel (optional):
      // better: ask backend to return a small sample; for now create synthetic
      const N = 2000;
      const mu = j.p50 ?? j.mean_credit;
      const sig = Math.max(1e-6, j.stdev_credit ?? 0.01);
      const arr = new Array(N).fill(0).map(()=> {
        // Box–Muller
        const u = Math.random()||1e-9, v = Math.random()||1e-9;
        const z = Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
        return Math.min(Math.max(mu + 0.75*sig*z, j.p5), j.p95);
      });
      drawHist($('#hist'), arr);

      if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise().catch(()=>{});
    } catch (e) {
      $('#errBox').textContent = e.message;
    }
  }

  $('#btnRun').addEventListener('click', runPricing);
  $('#btnClear').addEventListener('click', ()=>{
    $('#errBox').textContent = '';
    $('#mMean').textContent = '—';
    $('#mPV').textContent = '—';
    $('#mBand').textContent = '—';
    drawHist($('#hist'), []);
  });

  // Auto-run once with defaults
  document.addEventListener('DOMContentLoaded', runPricing);
  </script>

  <script>
document.addEventListener("DOMContentLoaded", () => {
  if (window.MathJax && MathJax.typesetPromise) {
    MathJax.typesetPromise().catch(err => console.error("MathJax error", err));
  }
});
</script>
</body>
</html>
