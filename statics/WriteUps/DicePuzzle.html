<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Dice Puzzle ‚Äî Max of k Minimums from n Dice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- global site theme -->
  <link rel="stylesheet" href="../css/cq.css" />

  <!-- page-level layout tweaks (match article / cli aesthetic) -->
  <style>
    .dice-shell {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem 2rem 4rem;
    }

    /* hero banner */
    .dice-hero {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      box-shadow: var(--panel-shadow);
      margin-bottom: 2rem;
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(260px,360px);
      gap: 2rem;
      backdrop-filter: blur(8px) saturate(1.15);
    }

    @media (max-width: 900px){
      .dice-hero {
        grid-template-columns: 1fr;
      }
    }

    .dice-hero-main {
      padding: 2rem 2rem 2.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .dice-hero-main h1 {
      margin: 0 0 .6rem;
      font-size: clamp(1.5rem,1.1rem + 1vw,2rem);
      line-height: 1.2;
      font-weight: 600;
      color: var(--fg);
    }

    .dice-hero-main p {
      margin: 0;
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.4;
    }

    .dice-hero-side {
      padding: 2rem 2rem 2.5rem;
      border-left: 1px solid var(--panel-border);
      display: flex;
      flex-direction: column;
      justify-content: center;
      background: radial-gradient(circle at 30% 30%, rgba(0,0,0,0.05) 0%, transparent 60%), radial-gradient(circle at 70% 70%, rgba(0,0,0,0.07) 0%, transparent 60%), linear-gradient(135deg,#e0e7ff 0%,#f4f8ff 60%);
      color: #0f172a;
      font-size: .9rem;
      line-height: 1.4;
    }
    @media (prefers-color-scheme: dark){
      .dice-hero-side {
        background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.07) 0%, transparent 60%), radial-gradient(circle at 70% 70%, rgba(255,255,255,0.05) 0%, transparent 60%), linear-gradient(135deg,#1E3A8A 0%,#0f172a 60%);
        color: #e8edf5;
      }
    }

    .dice-hero-side h2 {
      margin: 0 0 .5rem;
      font-size: .9rem;
      line-height: 1.3;
      font-weight: 600;
      color: inherit;
      letter-spacing: .01em;
    }

    .dice-hero-side p {
      margin: .4rem 0 .6rem;
      color: inherit;
    }

    .dice-hero-side .pill {
      display:inline-block;
      border:1px solid rgba(0,0,0,0.2);
      border-radius:999px;
      padding:.15rem .6rem;
      font-size:.75rem;
      font-weight:500;
      letter-spacing:.02em;
    }
    @media (prefers-color-scheme: dark){
      .dice-hero-side .pill {
        border:1px solid rgba(255,255,255,0.4);
      }
    }

    /* body grid: main sim on left, intuition / cards on right */
    .dice-body {
      display: grid;
      grid-template-columns: minmax(0,1fr) minmax(260px,340px);
      gap: 2rem;
    }
    @media (max-width: 1100px){
      .dice-body {
        grid-template-columns: 1fr;
      }
    }

    /* main panel */
    .dice-mainpanel {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      box-shadow: var(--panel-shadow);
      backdrop-filter: blur(6px) saturate(1.1);
      padding: 2rem 2rem 3rem;
      color: var(--fg);
      font-size: 1rem;
      line-height: 1.5;
    }

    .dice-mainpanel h2 {
      font-size: 1.05rem;
      line-height: 1.3;
      font-weight: 600;
      color: var(--fg);
      margin: 2rem 0 .5rem;
    }

    .dice-mainpanel p {
      margin: .8rem 0 1rem;
      color: var(--fg);
      font-size: 1rem;
      line-height: 1.5;
    }

    /* interactive cards inside main panel */
    .sim-card {
      background: rgba(0,0,0,0.03);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      padding: 1rem 1rem 1.25rem;
      margin-top: 1rem;
    }
    @media (prefers-color-scheme: dark){
      .sim-card {
        background: rgba(15,23,42,0.5);
      }
    }

    .sim-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 1.25rem;
      align-items: flex-start;
    }

    .sim-col {
      flex: 1 1 220px;
      min-width: 0;
    }

    .sim-label {
      font-size: .8rem;
      font-weight: 500;
      color: var(--fg);
      margin-bottom: .4rem;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      line-height:1.4;
    }

    .sim-label span.val {
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: .8rem;
      margin-left:.4rem;
    }

    .slider {
      width: 100%;
      accent-color: var(--accent);
    }

    .cq-btn {
      cursor: pointer;
      appearance: none;
      border: 0;
      font-size: .9rem;
      line-height: 1.2;
      font-weight: 500;
      border-radius: 8px;
      padding: .6rem .8rem;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 18px 32px rgba(37,99,235,0.28);
    }
    .cq-btn:hover {
      background: var(--accent-light);
    }

    .cq-btn-ghost {
      cursor: pointer;
      appearance: none;
      background: transparent;
      border: 1px solid var(--panel-border);
      font-size: .85rem;
      line-height: 1.2;
      font-weight: 500;
      border-radius: 8px;
      padding: .55rem .75rem;
      color: var(--fg);
    }

    .once-area-text {
      font-size: .85rem;
      line-height:1.4;
      color: var(--muted);
      margin-top: .5rem;
    }

    /* dice grid visual */
    .set-grid {
      display:grid;
      grid-template-columns: repeat(6, 32px);
      gap:.35rem;
      align-items:center;
      justify-content:start;
      margin-top:.5rem;
    }

    .die-cell {
      width:32px; height:32px;
      border:1px solid var(--panel-border);
      border-radius:6px;
      font-weight:600;
      font-size:.9rem;
      line-height:32px;
      text-align:center;
      color: var(--fg);
      background: rgba(0,0,0,0.02);
    }
    @media (prefers-color-scheme: dark){
      .die-cell {
        background: rgba(0,0,0,0.2);
      }
    }

    .die-min {
      background:#fde68a;
      color:#78350f;
      border-color:#facc15;
    }
    @media (prefers-color-scheme: dark){
      .die-min {
        background:#78350f;
        color:#fde68a;
        border-color:#78350f;
      }
    }

    .set-row.best-set {
      outline:2px solid #22c55e;
      outline-offset:3px;
      border-radius:6px;
    }

    /* histogram canvas */
    .hist-wrap {
      display:flex;
      flex-wrap:wrap;
      gap:1rem 1.25rem;
      margin-top:1rem;
    }

    .hist-left {
      flex: 1 1 260px;
    }

    .hist-right {
      flex: 1 1 200px;
      min-width:200px;
      font-size:.9rem;
      line-height:1.4;
    }

    .hist-right .stats-main {
      font-weight:600;
      font-size:.95rem;
      color: var(--fg);
      margin-bottom:.5rem;
    }

    .hist-right .stats-note {
      color: var(--muted);
      font-size:.8rem;
      line-height:1.4;
    }

    canvas {
      width:100%;
      height:220px;
      border:1px solid var(--panel-border);
      border-radius:12px;
      background: transparent;
    }

    /* collapsible math explainer */
    details.mathbox {
      background: rgba(0,0,0,0.02);
      border:1px solid var(--panel-border);
      border-radius:12px;
      padding: .9rem 1rem 1rem;
      font-size:.9rem;
      line-height:1.5;
      margin-top:2rem;
    }
    @media (prefers-color-scheme: dark){
      details.mathbox {
        background: rgba(15,23,42,0.4);
      }
    }

    details.mathbox summary {
      cursor: pointer;
      font-weight:600;
      font-size:.95rem;
      line-height:1.4;
      color: var(--fg);
      outline:none;
    }

    .math-inline-block {
      background: rgba(0,0,0,0.03);
      border-radius:4px;
      padding:.1rem .3rem;
      font-family: var(--font-mono);
      font-size:.8rem;
      line-height:1.4;
      display:inline-block;
    }
    @media (prefers-color-scheme: dark){
      .math-inline-block {
        background: rgba(15,23,42,0.5);
      }
    }

    /* right rail cards */
    .dice-side {
      display: grid;
      gap: 1.5rem;
      align-content: start;
    }

    .side-card {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      box-shadow: var(--panel-shadow);
      padding: 1rem 1rem 1.2rem;
      font-size: .9rem;
      line-height: 1.4;
      color: var(--fg);
    }

    .side-card h3 {
      margin: 0 0 .4rem;
      font-size: .9rem;
      line-height: 1.3;
      font-weight: 600;
      color: var(--fg);
      letter-spacing: .01em;
    }

    .side-card p {
      margin: .4rem 0 .6rem;
      color: var(--fg);
      font-size: .9rem;
      line-height: 1.4;
    }

    .footnote {
      text-align:center;
      font-size:.8rem;
      line-height:1.4;
      color: var(--muted);
      margin-top:3rem;
    }
  </style>

  <!-- MathJax config (same pattern as other longform pages) -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['\\[', '\\]'], ['$$','$$']],
        processEscapes: true,
        tags: 'ams'
      },
      options: { skipHtmlTags: ['script','noscript','style','textarea','pre','code'] }
    };
  </script>
  <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
</head>

<body>

  <!-- nav -->
  <div class="cq-shell" style="padding-top:1rem;">
    <nav class="cq-nav" style="justify-content:space-between;">
      <a class="cq-logo" href="../../index.html">‚òï CoffeeQuant</a>
      <div class="cq-navlinks">
        <a href="../../index.html#daily">Daily</a>
        <a href="../../index.html#labs" class="is-active">Labs</a>
        <a href="../../index.html#tools">Tools</a>
        <a href="../../index.html#notes">Notes</a>
        <a href="../../index.html#curios">Curios</a>
      </div>
    </nav>
  </div>

  <div class="dice-shell">

    <!-- hero -->
    <section class="dice-hero">
      <div class="dice-hero-main">
        <h1>Dice Puzzle ‚Äî ‚ÄúMax of k minimums from n dice‚Äù</h1>
        <p>
          Game: roll <strong>n</strong> dice at once. Take the <em>minimum</em> in that set.
          Do that <strong>k</strong> times. Now keep the <em>maximum</em> of those $k$ minimums.
          <br/><br/>
          Sounds innocent. Turns out it‚Äôs a great intuition builder for extremes, order stats,
          ‚Äúbest of the worst,‚Äù and why expected value creeps up in layers.
        </p>
      </div>

      <div class="dice-hero-side">
        <h2>Quick facts</h2>
        <p>
          This puzzle came from watching two kids play with dice on a long train ride.
          The structure is:
        </p>
        <p class="pill">repeat</p>
        <p style="font-family:var(--font-mono); font-size:.8rem; line-height:1.4;">
          roll n dice ‚Üí take min ‚Üí store it
        </p>
        <p class="pill">then</p>
        <p style="font-family:var(--font-mono); font-size:.8rem; line-height:1.4;">
          after k rounds ‚Üí take max of those mins
        </p>
        <p style="margin-top:.5rem;">
          For \(n=6,k=6\), the average answer is around 2.4‚Äì2.5.
          You‚Äôre about to reproduce that yourself.
        </p>
      </div>
    </section>

    <!-- main content grid -->
    <section class="dice-body">

      <!-- MAIN LEFT COLUMN -->
      <article class="dice-mainpanel">

        <!-- Interactive Part 1: single run -->
        <h2>Play it once</h2>
        <p>
          Pick how many dice per round (<span class="math-inline-block">n</span>)
          and how many rounds (<span class="math-inline-block">k</span>).
          Click ‚ÄúOne run.‚Äù We‚Äôll roll it live, highlight each round‚Äôs minimum,
          and outline the round that produced the <strong>best</strong> minimum.
        </p>

        <div class="sim-card">
          <div class="sim-row">
            <div class="sim-col">
              <label class="sim-label">
                <span>Dice per round <strong>n</strong></span>
                <span class="val" id="nOut">6</span>
              </label>
              <input id="nDice" class="slider" type="range" min="1" max="12" value="6" oninput="updateLabels()" />
            </div>

            <div class="sim-col">
              <label class="sim-label">
                <span>Rounds <strong>k</strong></span>
                <span class="val" id="kOut">6</span>
              </label>
              <input id="nSets" class="slider" type="range" min="1" max="12" value="6" oninput="updateLabels()" />
            </div>

            <div class="sim-col" style="display:flex;align-items:flex-end;">
              <button class="cq-btn" style="width:100%;" onclick="stepOnce()">üé≤ One run</button>
            </div>
          </div>

          <div id="onceArea" style="margin-top:1rem;"></div>
          <div id="onceText" class="once-area-text"></div>
        </div>

        <!-- Interactive Part 2: many trials -->
        <h2>Run a lot of trials</h2>
        <p>
          Now we repeat the full game many times and build a histogram of the final ‚Äúmax-of-mins.‚Äù
          Watch how the distribution leans upward as you increase
          <span class="math-inline-block">n</span> or <span class="math-inline-block">k</span>.
        </p>

        <div class="sim-card">
          <div class="sim-row">
            <div class="sim-col">
              <label class="sim-label">
                <span>Trials (simulated games)</span>
                <span class="val" id="tOut">1000</span>
              </label>
              <input id="nTrials" class="slider" type="range" min="100" max="10000" step="100" value="1000" oninput="updateLabels()" />
            </div>

            <div class="sim-col" style="display:flex;gap:.5rem;align-items:flex-end;flex-wrap:wrap;">
              <button class="cq-btn" style="flex:1 1 auto;" onclick="runTrials()">üöÄ Run simulation</button>
              <button class="cq-btn-ghost" style="flex:1 1 auto;" onclick="clearSim()">Clear</button>
            </div>
          </div>

          <div class="hist-wrap">
            <div class="hist-left">
              <canvas id="hist"></canvas>
            </div>
            <div class="hist-right">
              <div id="stats">
                <!-- mean etc goes here -->
              </div>
              <div class="stats-note">
                Tip: bigger <span class="math-inline-block">n</span> lets you avoid low dice inside a round,
                and bigger <span class="math-inline-block">k</span> lets you ‚Äúshop around‚Äù
                for a lucky round. Both push the final answer higher.
              </div>
            </div>
          </div>
        </div>

        <!-- Intuition -->
        <h2>What's going on intuitively?</h2>
        <p>
          In each round, the <strong>minimum</strong> of \(n\) dice is usually low.
          With 6 dice, someone almost always rolls a 1 or 2, so the min is often ugly.
        </p>
        <p>
          But you don‚Äôt keep that minimum. You repeat the whole round \(k\) times,
          then you keep the <em>best</em> round ‚Äî specifically, the highest minimum.
          One of those rounds will be ‚Äúsurprisingly clean,‚Äù where nobody rolled a 1.
        </p>
        <p>
          That‚Äôs why for \(n=6,k=6\), the ‚Äúfinal score‚Äù (max of mins) averages around 2.4-ish.
          You‚Äôre seeing ‚Äúthe best floor‚Äù you managed to produce out of 6 attempts.
        </p>

        <!-- Math box -->
        <details class="mathbox" id="mathBox">
          <summary>Show me the math and let me derive it</summary>

          <div style="margin-top:.75rem;">
            <h2 style="margin-top:0;font-size:1rem;">1) The minimum of one round</h2>
            <p>
              Call the minimum of \(n\) dice \(Y\).
              For \(Y\) to be at least \(a\), every die in that round has to be \(\ge a\).
              A single fair die is \(\ge a\) with probability \(\frac{7-a}{6}\) (because values \(a,a+1,\dots,6\)).
            </p>

            <p>
              Dice are independent, so
              \[
                \mathbb{P}(Y \ge a)
                = \Big(\tfrac{7-a}{6}\Big)^{n}.
              \]
            </p>

            <p>
              That means the chance the minimum is <em>exactly</em> \(a\) is
              ‚Äúmin is at least \(a\)‚Äù minus ‚Äúmin is at least \(a+1\)‚Äù:
            </p>

            <p>
              \[
                \mathbb{P}(Y=a)
                = \Big(\tfrac{7-a}{6}\Big)^{n}
                  - \Big(\tfrac{6-a}{6}\Big)^{n},
                \quad a=1,\dots,6.
              \]
            </p>

            <h2 style="font-size:1rem;">2) The max of \(k\) rounds</h2>
            <p>
              Now repeat the whole round \(k\) times. Let \(Y_1,\dots,Y_k\) be the minimum from each round.
              We keep
              \[
                Z = \max(Y_1,\dots,Y_k).
              \]
            </p>

            <p>
              ‚Äú\(Z \le a\)‚Äù means <em>every</em> round had minimum \(\le a\).
              If \(F_Y(a)=\mathbb{P}(Y \le a)\), then
              \[
                \mathbb{P}(Z \le a) = [F_Y(a)]^{k}.
              \]
            </p>

            <p>
              We already know
              \[
                \mathbb{P}(Y \ge a)
                = \Big(\tfrac{7-a}{6}\Big)^n,
              \quad\Rightarrow\quad
                \mathbb{P}(Y \le a)
                = 1 - \Big(\tfrac{6-a}{6}\Big)^n.
              \]
            </p>

            <p>
              So the probability \(Z\) is exactly \(a\) is
              \[
                \mathbb{P}(Z=a)
                = [F_Y(a)]^{k} - [F_Y(a-1)]^{k},
              \]
              with \(F_Y(a) = 1 - \big(\tfrac{6-a}{6}\big)^n\).
            </p>

            <h2 style="font-size:1rem;">3) Expected score</h2>
            <p>
              You can now compute the expected final score:
            </p>

            <p>
              \[
                \mathbb{E}[Z]
                = \sum_{a=1}^{6} a \cdot \mathbb{P}(Z=a).
              \]
            </p>

            <p>
              Or equivalently, use tail probs:
              \[
                \mathbb{E}[Z]
                = \sum_{a=1}^{6} \mathbb{P}(Z \ge a),
                \quad
                \mathbb{P}(Z \ge a) = 1 - [F_Y(a-1)]^{k}
                = 1 - \Big(1 - \big(\tfrac{7-a}{6}\big)^{n}\Big)^{k}.
              \]
            </p>

            <p style="color:var(--muted);font-size:.8rem;line-height:1.4;">
              The point is: the formulas just encode what you already saw in the sim.
              You‚Äôre selecting ‚Äúthe best floor‚Äù out of \(k\) tries.
              Bigger \(n\) (more dice per round) and bigger \(k\) (more chances)
              both push that floor up.
            </p>
          </div>
        </details>

        <div class="footnote">
          ‚òï CoffeeQuant ¬∑ roll fast, reason clearly. No ads.
        </div>

      </article>

      <!-- RIGHT COLUMN / SIDE CARDS -->
      <aside class="dice-side">

        <div class="side-card">
          <h3>Rules of the game</h3>
          <p>
            1. Roll \(n\) dice at once. Write down the <strong>minimum</strong> face.
          </p>
          <p>
            2. Repeat that whole thing \(k\) times ‚Üí get \(k\) minimums.
          </p>
          <p>
            3. Your score is the <em>maximum</em> of those \(k\) minimums.
          </p>
          <p style="font-family:var(--font-mono);font-size:.8rem;">
            score = max(min(set 1), min(set 2), ‚Ä¶, min(set k))
          </p>
        </div>

        <div class="side-card">
          <h3>Why it's cool</h3>
          <p>
            This is basically an ‚Äúextreme of an extreme.‚Äù
            First you scrape the floor (the min),
            then you keep the best floor.
          </p>
          <p>
            That logic shows up in risk limits,
            worst-case P&amp;L screens,
            and even tournament formats
            (‚Äúyour worst round doesn‚Äôt kill you if you had one really solid round‚Äù).
          </p>
        </div>

        <div class="side-card">
          <h3>What to look for</h3>
          <p>
            Try small \(n\) vs big \(n\).
            With more dice per round you almost never get a total disaster,
            so each round‚Äôs minimum creeps up.
          </p>
          <p>
            Then try small \(k\) vs big \(k\).
            More rounds means more chances for a ‚Äúclean‚Äù round.
          </p>
          <p>
            Both act like ‚Äúfree optionality.‚Äù
          </p>
        </div>

      </aside>

    </section>

    <!-- footer links -->
    <div class="cli-footerlinks" style="text-align:center;font-size:.85rem;color:var(--muted);margin-top:3rem;">
      <div>‚òï CoffeeQuant ¬∑ Fast. Minimal. Curious. No ads.</div>
      <div style="margin-top:.4rem;">
        <a href="../../index.html#labs" style="color:var(--accent);text-decoration:none;">‚Üê Back to Labs</a>
        ¬∑
        <a href="../../index.html#tools" style="color:var(--accent);text-decoration:none;">Try the Pricing CLI</a>
      </div>
    </div>

  </div>

  <!-- JS logic (same engine as your previous version, just with new class names) -->
  <script>
    // --- utilities ---
    function rollDie(){ return (Math.random()*6|0)+1; }

    function oneRun(nDice, nSets){
      const mins = [];
      const perSet = [];
      for(let s=0;s<nSets;s++){
        const rolls = Array.from({length:nDice}, rollDie);
        perSet.push(rolls);
        mins.push(Math.min(...rolls));
      }
      return { perSet, mins, maxOfMins: Math.max(...mins) };
    }

    function drawOnce(perSet, mins, maxOfMins){
      const area = document.getElementById("onceArea");
      area.innerHTML = "";
      perSet.forEach((rolls, i) => {
        // wrapper row
        const rowWrap = document.createElement("div");
        rowWrap.className = "set-row set-grid";
        if (mins[i] === maxOfMins) rowWrap.classList.add("best-set");

        rolls.forEach(v => {
          const cell = document.createElement("div");
          cell.className = "die-cell" + (v === mins[i] ? " die-min" : "");
          cell.textContent = v;
          rowWrap.appendChild(cell);
        });

        area.appendChild(rowWrap);
      });
    }

    // --- controls ---
    function $(id){ return document.getElementById(id); }

    function updateLabels(){
      $("nOut").textContent   = $("nDice").value;
      $("kOut").textContent   = $("nSets").value;
      $("tOut").textContent   = $("nTrials").value;
    }
    updateLabels();

    function stepOnce(){
      const n = +$("nDice").value, k = +$("nSets").value;
      const {perSet, mins, maxOfMins} = oneRun(n,k);
      drawOnce(perSet, mins, maxOfMins);
      $("onceText").innerHTML =
        `Minimum per round: <strong>${mins.join(", ")}</strong><br>`+
        `Final score (best minimum): <strong>${maxOfMins}</strong> (outlined)`;
    }

    // --- many trials + histogram ---
    let histData = new Array(6).fill(0);

    function runTrials(){
      const n = +$("nDice").value, k = +$("nSets").value, T = +$("nTrials").value;
      histData.fill(0);
      for(let t=0;t<T;t++){
        const {maxOfMins} = oneRun(n,k);
        histData[maxOfMins-1]++;
      }
      drawHist(histData, T);
      const mean = histData.reduce((s,c,i)=>s + (i+1)*c, 0)/T;
      const probs = histData.map(c=> (c/T).toFixed(3));
      $("stats").innerHTML =
        `<div class="stats-main">Average (empirical): ${mean.toFixed(3)}</div>`+
        `<div class="stats-note">P(1..6) = [ ${probs.join(" , ")} ]</div>`;
    }

    function clearSim(){
      histData.fill(0);
      const c = $("hist");
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);
      $("stats").innerHTML = "";
    }

    function drawHist(data, T){
      const c = $("hist");
      const ctx = c.getContext("2d");

      const pixelRatio = window.devicePixelRatio || 1;
      const cssW = c.clientWidth || 300;
      const cssH = 220;
      c.width  = cssW * pixelRatio;
      c.height = cssH * pixelRatio;

      ctx.setTransform(pixelRatio,0,0,pixelRatio,0,0);
      ctx.clearRect(0,0,cssW,cssH);

      const left = 36, bottom = 24, top = 10, right = 10;
      const plotW = cssW - left - right;
      const plotH = cssH - top - bottom;

      const fg = getComputedStyle(document.body).color;
      const borderCol = getComputedStyle(document.body).getPropertyValue('--panel-border') || 'rgba(0,0,0,0.2)';

      // axes
      ctx.strokeStyle = fg;
      ctx.globalAlpha = 0.3;
      ctx.beginPath();
      ctx.moveTo(left, top); ctx.lineTo(left, top+plotH); ctx.lineTo(left+plotW, top+plotH);
      ctx.stroke();
      ctx.globalAlpha = 1;

      // bars 1..6
      const nBars = 6;
      const gap = 10, bw = (plotW - (nBars+1)*gap)/nBars;
      const maxP = Math.max(...data)/T || 1;

      ctx.fillStyle = fg;
      data.forEach((count, i) => {
        const p = count/T;
        const h = p/maxP * plotH;
        const x = left + gap + i*(bw+gap);
        const y = top + plotH - h;

        ctx.globalAlpha = .15;
        ctx.fillRect(x, y, bw, h);
        ctx.globalAlpha = 1;

        ctx.font = "10px " + getComputedStyle(document.body).getPropertyValue('--font-mono');
        ctx.fillText(String(i+1), x + bw/2-3, top+plotH+14);
        ctx.fillText(p.toFixed(2), x + bw/2-10, y-4);
      });

      ctx.globalAlpha = 1;
    }

    // --- math typeset when opening the details ---
    const mathBox = $("mathBox");
    if (mathBox){
      mathBox.addEventListener("toggle", function(){
        if (mathBox.open && window.MathJax && MathJax.typesetPromise){
          MathJax.typesetPromise([mathBox]).catch((e)=>console.error("MathJax:", e));
        }
      });
    }

    // typeset on load
    (function(){
      if (window.MathJax && MathJax.typesetPromise){
        MathJax.typesetPromise().catch(()=>{});
      }
    })();
  </script>

</body>
</html>
